# GitHub Actions workflow configuration file - Python macOS ARM64 platform compilation
# This file configures the CI/CD pipeline for automatically compiling Python extension packages and uploading to PyPI in macOS ARM64 environment

name: Py4macOS-ARM64  # Workflow name, displayed in GitHub Actions interface

# Trigger conditions configuration
on:
  workflow_dispatch:  # Manual trigger
  pull_request:       # Pull Request trigger
  push:
    branches:
      - main          # Trigger when pushing to main branch
      - testpypi      # Trigger test upload when pushing to testpypi branch
  release:
    types:
      - published     # Trigger when publishing Release

# Job definitions
jobs:
  build:
    strategy:
      fail-fast: false  # Don't terminate other jobs due to single job failure
      matrix:
        os: [macos-12, macos-13, macos-14, macos-15]  # Multiple macOS versions support: macOS 12, 13, 14, 15 with ARM64 focus
        python-version: ["3.10",
                         "3.11", 
                         "3.12",
                         "3.13",]

    runs-on: ${{ matrix.os }}  # Specify runtime environment

    steps:
      # Step 1: Checkout source code
      - uses: actions/checkout@v4  # Upgrade to v4 version
        with:
          submodules: recursive    # Recursively checkout all submodules

      # Step 2: Setup Python environment
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # Step 3: Check architecture and skip non-ARM64
      - name: Check architecture and skip non-ARM64
        run: |
          echo "Current architecture: $(uname -m)"
          echo "Current OS: ${{ matrix.os }}"
          if [ "$(uname -m)" != "arm64" ]; then
            echo "Skipping: This workflow is designed for ARM64 architecture only"
            echo "Current architecture $(uname -m) is not supported"
            exit 78  # Use exit code 78 to skip this job gracefully
          fi
          echo "✓ Confirmed running on ARM64 architecture"

      # Step 4: Install system dependencies
      - name: Install system dependencies
        run: |
          brew update  # Update Homebrew package manager
          brew install cmake ninja pkg-config protobuf

      # Step 5: Update Python dependencies
      - name: Update Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pybind11 setuptools wheel twine requests pathlib cython

      # Step 6: Install Rust toolchain
      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup update

      # Step 7: Install OpenCV and ONNXRUNTIME
      - name: Install OpenCV and ONNXRUNTIME
        run: |
          cd tool/script
          python install_opencv.py
          python install_onnxruntime.py

      # Step 8: Configure CMake build environment
      - name: Configure build
        run: |
          mkdir build                    # Create build directory (out-of-source build)
          cp cmake/config_opencv_ort_tokenizer.cmake build/config.cmake   # Copy project-specific CMake configuration file
          cd build                       # Enter build directory
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_OSX_ARCHITECTURES=arm64 ..

      # Step 9: Execute compilation
      - name: Compile C++ library
        run: |
          cd build                    # Enter build directory
          ninja -j$(sysctl -n hw.ncpu)  # Parallel compilation using all CPU cores
          ninja install

      # Step 10: Build and install Python package
      - name: Build Python package
        run: |
          cd python
          pip install -e .
          python setup.py bdist_wheel  # Build wheel package

      # Step 11: Verify compilation results
      - name: Check compilation results
        run: |
          cd python/dist    # Enter Python package directory
          ls -la            # List generated wheel files
          echo "Python package compilation completed on ARM64 ${{ matrix.os }}"  # Output completion information with OS version

      # Step 12: Verify Python package import
      - name: Verify Python package
        run: |
          python -c "
          import platform
          try:
              import nndeploy
              print(f'✓ Successfully imported nndeploy {nndeploy.__version__}')
              print(f'Platform: {platform.platform()}')
              print(f'Architecture: {platform.machine()}')
              print(f'Python version: {platform.python_version()}')
              print(f'macOS ARM64 runner: ${{ matrix.os }}')
              # Verify this is indeed ARM64
              if platform.machine() != 'arm64':
                  print(f'✗ Warning: Expected arm64 but got {platform.machine()}')
                  exit(1)
              print('✓ Confirmed ARM64 architecture')
          except ImportError as e:
              print(f'✗ Import failed: {e}')
              exit(1)
          "

      # Step 13: Upload to TestPyPI (when pushing to testpypi branch)
      - name: Upload to TestPyPI
        if: github.ref == 'refs/heads/testpypi'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_NNDEPLOY_TOKEN }}
        run: |
          cd python
          twine check dist/*
          twine upload --repository-url https://test.pypi.org/legacy/ dist/*.whl

      # Step 14: Upload to official PyPI (when publishing Release)
      - name: Upload to PyPI
        if: github.event_name == 'release' && github.event.action == 'published'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_NNDEPLOY_TOKEN }}
        run: |
          cd python
          twine check dist/*
          twine upload dist/*.whl

      # Step 15: Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-python${{ matrix.python-version }}-arm64-wheel
          path: python/dist/*.whl
          retention-days: 7