# GitHub Actions workflow configuration file - Windows platform compilation
# This file is used to configure the CI/CD process for automatic project compilation in Windows environment

name: Windows  # Workflow name, displayed in GitHub Actions interface

# Trigger condition configuration
on:
  # Triggered when code is pushed to specified branches
  push:
    branches: [main, develop, 'feature/**']
    paths:  # Only trigger build when files in the following paths change
      - 'framework/**'     # Framework core code directory
      - 'plugin/**'        # Plugin extension code directory
      - 'python/src/**'    # Python binding code directory (pybind11 related)
      - 'test/**'          # Unit test and integration test code directory
      - 'demo/**'          # Example and demo code directory
      - 'cmake/**'         # CMake build configuration file directory
      - 'CMakeLists.txt'   # Main CMake build configuration file
      - '.github/workflows/windows.yml'  # Current workflow file itself
  # Triggered when creating Pull Request to specified branches
  pull_request:
    branches: [main]  # Only trigger when PR target branch is main
    paths:  # Same path filtering conditions as push
      - 'framework/**'     # Framework core code directory
      - 'plugin/**'        # Plugin extension code directory
      - 'python/src/**'    # Python binding code directory
      - 'test/**'          # Test code directory
      - 'demo/**'          # Example code directory
      - 'cmake/**'         # CMake configuration file directory
      - 'CMakeLists.txt'   # Main CMake build file
      - '.github/workflows/windows.yml'  # Current workflow file

# Job definition
jobs:
  build:  # Job ID
    name: Windows Build  # Job display name
    runs-on: windows-latest  # Specify runtime environment as latest Windows
  
    steps:  # Build step sequence
      # Step 1: Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4  # Use GitHub official code checkout Action (v4 version)
        with:
          submodules: recursive  # Recursively checkout all submodules (git submodule)
          
      # Step 2: Setup Python environment
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
        
      # Step 3: Setup Visual Studio environment
      - name: Setup Visual Studio build environment
        uses: microsoft/setup-msbuild@v1.1  # Setup MSBuild build tools

      # Step 4: Update Python dependencies
      - name: Update Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pybind11 setuptools wheel twine requests pathlib cython

      # Step 5: Setup Rust toolchain
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      # Step 6: Install OpenCV and ONNXRUNTIME
      - name: Install OpenCV and ONNXRUNTIME
        run: |
          cd tool/script
          python install_opencv.py
          python install_onnxruntime.py
          
      # Verify third-party library installation status
      - name: Verify third-party library installation
        run: |
          echo "Verifying OpenCV installation..."
          if (Test-Path "tool/script/third_party/opencv4.8.0/lib") {
            dir tool/script/third_party/opencv4.8.0/lib
          } else {
            echo "OpenCV library directory does not exist"
            exit 1
          }
          
          echo "Verifying ONNX Runtime installation..."
          if (Test-Path "tool/script/third_party/onnxruntime1.18.0/lib") {
            dir tool/script/third_party/onnxruntime1.18.0/lib
          } else {
            echo "ONNX Runtime library directory does not exist"
            exit 1
          }
        shell: powershell
            
      # Step 7: Configure CMake build environment
      - name: Configure build
        run: |
          mkdir build                    # Create build directory (out-of-source build)
          cp cmake/config_windows.cmake build/config.cmake   # Copy project-specific CMake configuration file
          cd build                       # Enter build directory
          cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_POLICY_VERSION_MINIMUM=3.5 ..  # Configure using Visual Studio 2022 generator
          
      # Step 8: Compile, install, package and verify
      - name: Compile, install, package and verify
        run: |
          cd build                                      # Enter build directory
          cmake --build . --config Release -j 4        # Compile in parallel using Release configuration
          cmake --install . --config Release           # Install compiled files
          cpack -C Release                              # Use CPack to generate installation packages
          dir                                           # List all generated files and directories
          echo "Compilation, installation and packaging completed"                   # Output completion information
          
      # Step 9: Python developer mode installation and verification
      - name: Python developer mode installation and verification
        run: |
          cd python                     # Enter Python package directory
          pip install -e .              # Install Python package in developer mode
          cd ..                         # Return to root directory
          # Verify if Python package is correctly installed
          python -c "
          import platform
          try:
              import nndeploy
              print(f'[ok] Successfully imported nndeploy {nndeploy.__version__}')
              print(f'Platform: {platform.platform()}')
              print(f'Architecture: {platform.machine()}')
              print(f'Python version: {platform.python_version()}')
          except ImportError as e:
              print(f'[failed] Import failed: {e}')
              exit(1)
          "
          echo "Python package developer mode installation and verification completed"
      
      # Step 10: Upload build artifacts
      - name: Upload packaged library
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-package
          path: build/*.zip
          retention-days: 7

      # Step 11: Upload to Release Assets (only when pushing tags)
      - name: Upload package to Release Assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
